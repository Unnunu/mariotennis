.include "macro.inc"

.set noat
.set noreorder
.set gp=64

.section .text, "ax"

/* Generated by spimdisasm 1.31.0 */

glabel boot_decompress
    /* 1080 80300080 27BDFFE8 */  addiu      $sp, $sp, -0x18
    /* 1084 80300084 AFBF0010 */  sw         $ra, 0x10($sp)

/* t2 - number of segments to decompress, there is only one */

    /* 1088 80300088 240A0001 */  addiu      $t2, $zero, 0x1
    /* 108C 8030008C 3C0DA010 */  lui        $t5, (0xA0100000 >> 16)
    /* 1090 80300090 3C0C0080 */  lui        $t4, (0x800000 >> 16)
    /* 1094 80300094 240B0001 */  addiu      $t3, $zero, 0x1
    /* 1098 80300098 24880004 */  addiu      $t0, $a0, 0x4        // skip first 4 bytes
  1:

/* clear memory from  0xA0000400 to 0xA0100000 */
    /* 109C 8030009C 3C02A000 */  lui        $v0, (0xA0000400 >> 16)
    /* 10A0 803000A0 34420400 */  ori        $v0, $v0, (0xA0000400 & 0xFFFF)
  2:
    /* 10A4 803000A4 FC400000 */  sd         $zero, 0x0($v0)
    /* 10A8 803000A8 FC400008 */  sd         $zero, 0x8($v0)
    /* 10AC 803000AC FC400010 */  sd         $zero, 0x10($v0)
    /* 10B0 803000B0 FC400018 */  sd         $zero, 0x18($v0)
    /* 10B4 803000B4 FC400020 */  sd         $zero, 0x20($v0)
    /* 10B8 803000B8 FC400028 */  sd         $zero, 0x28($v0)
    /* 10BC 803000BC FC400030 */  sd         $zero, 0x30($v0)
    /* 10C0 803000C0 FC400038 */  sd         $zero, 0x38($v0)
    /* 10C4 803000C4 24420040 */  addiu      $v0, $v0, 0x40
    /* 10C8 803000C8 144DFFF6 */  bne        $v0, $t5, 2b
    /* 10CC 803000CC 00000000 */   nop
  
  /* set destination address 0x80031000 */
  /* TODO: symbolize it */

    /* 10D0 803000D0 3C068003 */  lui        $a2, 0x8003
    /* 10D4 803000D4 24C61000 */  addiu      $a2, $a2, (0x80031000 & 0xFFFF)
  3:
    /* 10D8 803000D8 91070000 */  lbu        $a3, 0x0($t0)        // read one byte from stream
    /* 10DC 803000DC 14E00008 */  bnez       $a3, 4f
    /* 10E0 803000E0 25080001 */   addiu     $t0, $t0, 0x1        // if zero then copy 8 bytes verbatim
    /* 10E4 803000E4 69010000 */  ldl        $at, 0x0($t0)
    /* 10E8 803000E8 6D010007 */  ldr        $at, 0x7($t0)
    /* 10EC 803000EC B0C10000 */  sdl        $at, 0x0($a2)
    /* 10F0 803000F0 B4C10007 */  sdr        $at, 0x7($a2)
    /* 10F4 803000F4 25080008 */  addiu      $t0, $t0, 0x8
    /* 10F8 803000F8 080C0036 */  j          3b
    /* 10FC 803000FC 24C60008 */   addiu     $a2, $a2, 0x8
  4:
    /* 1100 80300100 00073E00 */  sll        $a3, $a3, 24
    /* 1104 80300104 00EC3825 */  or         $a3, $a3, $t4
  .L80300108:
    /* 1108 80300108 04E0001E */  bltz       $a3, .L80300184
    /* 110C 8030010C 00073840 */   sll       $a3, $a3, 1

    /* 1110 80300110 91020000 */  lbu        $v0, 0x0($t0)
    /* 1114 80300114 04E0003A */  bltz       $a3, .L80300200
    /* 1118 80300118 A0C20000 */   sb        $v0, 0x0($a2)

    /* 111C 8030011C 91020001 */  lbu        $v0, 0x1($t0)
    /* 1120 80300120 00073840 */  sll        $a3, $a3, 1
    /* 1124 80300124 04E00033 */  bltz       $a3, .L803001F4
    /* 1128 80300128 A0C20001 */   sb        $v0, 0x1($a2)

    /* 112C 8030012C 91020002 */  lbu        $v0, 0x2($t0)
    /* 1130 80300130 00073840 */  sll        $a3, $a3, 1
    /* 1134 80300134 04E0002C */  bltz       $a3, .L803001E8
    /* 1138 80300138 A0C20002 */   sb        $v0, 0x2($a2)

    /* 113C 8030013C 91020003 */  lbu        $v0, 0x3($t0)
    /* 1140 80300140 00073840 */  sll        $a3, $a3, 1
    /* 1144 80300144 04E00025 */  bltz       $a3, .L803001DC
    /* 1148 80300148 A0C20003 */   sb        $v0, 0x3($a2)

    /* 114C 8030014C 91020004 */  lbu        $v0, 0x4($t0)
    /* 1150 80300150 00073840 */  sll        $a3, $a3, 1
    /* 1154 80300154 04E0001E */  bltz       $a3, .L803001D0
    /* 1158 80300158 A0C20004 */   sb        $v0, 0x4($a2)

    /* 115C 8030015C 91020005 */  lbu        $v0, 0x5($t0)
    /* 1160 80300160 00073840 */  sll        $a3, $a3, 1
    /* 1164 80300164 04E00017 */  bltz       $a3, .L803001C4
    /* 1168 80300168 A0C20005 */   sb        $v0, 0x5($a2)

    /* 116C 8030016C 91020006 */  lbu        $v0, 0x6($t0)
    /* 1170 80300170 00073840 */  sll        $a3, $a3, 1
    /* 1174 80300174 25080007 */  addiu      $t0, $t0, 0x7
    /* 1178 80300178 A0C20006 */  sb         $v0, 0x6($a2)

    /* 117C 8030017C 24C60007 */  addiu      $a2, $a2, 0x7
  .L80300180:
    /* 1180 80300180 00073840 */  sll        $a3, $a3, 1
  .L80300184:
    /* 1184 80300184 10E0FFD4 */  beqz       $a3, 3b
    /* 1188 80300188 00000000 */   nop

    /* 118C 8030018C 91030001 */  lbu        $v1, 0x1($t0)
    /* 1190 80300190 91050000 */  lbu        $a1, 0x0($t0)
    /* 1194 80300194 00C31823 */  subu       $v1, $a2, $v1
    /* 1198 80300198 30A200F0 */  andi       $v0, $a1, 0xF0
    /* 119C 8030019C 00021100 */  sll        $v0, $v0, 4
    /* 11A0 803001A0 00621823 */  subu       $v1, $v1, $v0
    /* 11A4 803001A4 1066002E */  beq        $v1, $a2, .L80300260
    /* 11A8 803001A8 30A5000F */   andi      $a1, $a1, 0xF
    /* 11AC 803001AC 14A00017 */  bnez       $a1, .L8030020C
    /* 11B0 803001B0 00000000 */   nop
    /* 11B4 803001B4 91020002 */  lbu        $v0, 0x2($t0)
    /* 11B8 803001B8 25080003 */  addiu      $t0, $t0, 0x3
    /* 11BC 803001BC 080C008C */  j          .L80300230
    /* 11C0 803001C0 24420011 */   addiu     $v0, $v0, 0x11
  .L803001C4:
    /* 11C4 803001C4 24C60006 */  addiu      $a2, $a2, 0x6
    /* 11C8 803001C8 080C0060 */  j          .L80300180
    /* 11CC 803001CC 25080006 */   addiu     $t0, $t0, 0x6
  .L803001D0:
    /* 11D0 803001D0 24C60005 */  addiu      $a2, $a2, 0x5
    /* 11D4 803001D4 080C0060 */  j          .L80300180
    /* 11D8 803001D8 25080005 */   addiu     $t0, $t0, 0x5
  .L803001DC:
    /* 11DC 803001DC 24C60004 */  addiu      $a2, $a2, 0x4
    /* 11E0 803001E0 080C0060 */  j          .L80300180
    /* 11E4 803001E4 25080004 */   addiu     $t0, $t0, 0x4
  .L803001E8:
    /* 11E8 803001E8 24C60003 */  addiu      $a2, $a2, 0x3
    /* 11EC 803001EC 080C0060 */  j          .L80300180
    /* 11F0 803001F0 25080003 */   addiu     $t0, $t0, 0x3
  .L803001F4:
    /* 11F4 803001F4 24C60002 */  addiu      $a2, $a2, 0x2
    /* 11F8 803001F8 080C0060 */  j          .L80300180
    /* 11FC 803001FC 25080002 */   addiu     $t0, $t0, 0x2
  .L80300200:
    /* 1200 80300200 24C60001 */  addiu      $a2, $a2, 0x1
    /* 1204 80300204 080C0060 */  j          .L80300180
    /* 1208 80300208 25080001 */   addiu     $t0, $t0, 0x1
  .L8030020C:
    /* 120C 8030020C 14AB0007 */  bne        $a1, $t3, .L8030022C
    /* 1210 80300210 25080002 */   addiu     $t0, $t0, 0x2
    /* 1214 80300214 90620000 */  lbu        $v0, 0x0($v1)
    /* 1218 80300218 A0C20000 */  sb         $v0, 0x0($a2)
    /* 121C 8030021C 90620001 */  lbu        $v0, 0x1($v1)
    /* 1220 80300220 A0C20001 */  sb         $v0, 0x1($a2)
    /* 1224 80300224 080C0042 */  j          .L80300108
    /* 1228 80300228 24C60002 */   addiu     $a2, $a2, 0x2
  .L8030022C:
    /* 122C 8030022C 24A20001 */  addiu      $v0, $a1, 0x1
  .L80300230:
    /* 1230 80300230 00C24821 */  addu       $t1, $a2, $v0
    /* 1234 80300234 90620000 */  lbu        $v0, 0x0($v1)
    /* 1238 80300238 24630001 */  addiu      $v1, $v1, 0x1
    /* 123C 8030023C 24C50001 */  addiu      $a1, $a2, 0x1
    /* 1240 80300240 A0C20000 */  sb         $v0, 0x0($a2)
  .L80300244:
    /* 1244 80300244 90620000 */  lbu        $v0, 0x0($v1)
    /* 1248 80300248 24630001 */  addiu      $v1, $v1, 0x1
    /* 124C 8030024C 24A50001 */  addiu      $a1, $a1, 0x1
    /* 1250 80300250 14A9FFFC */  bne        $a1, $t1, .L80300244
    /* 1254 80300254 A0A2FFFF */   sb        $v0, -0x1($a1)
    /* 1258 80300258 080C0042 */  j          .L80300108
    /* 125C 8030025C 00A03021 */   addu      $a2, $a1, $zero
  .L80300260:
    /* 1260 80300260 254AFFFF */  addiu      $t2, $t2, -0x1
    /* 1264 80300264 1540FF8D */  bnez       $t2, 1b
    /* 1268 80300268 24880004 */   addiu     $t0, $a0, 0x4
    /* 126C 8030026C 0C0C00A8 */  jal        boot_invaldcache
    /* 1270 80300270 00000000 */   nop
    /* 1274 80300274 3C048003 */  lui        $a0, 0x8003
    /* 1278 80300278 24841000 */  addiu      $a0, $a0, (0x80031000 & 0xFFFF)
    /* 127C 8030027C 3C058008 */  lui        $a1, %hi(D_8007D000)
    /* 1280 80300280 24A5D000 */  addiu      $a1, $a1, %lo(D_8007D000)
    /* 1284 80300284 0C0C00B4 */  jal        boot_osInvalICache
    /* 1288 80300288 00A42823 */   subu      $a1, $a1, $a0
    /* 128C 8030028C 8FBF0010 */  lw         $ra, 0x10($sp)
    /* 1290 80300290 03E00008 */  jr         $ra
    /* 1294 80300294 27BD0018 */   addiu     $sp, $sp, 0x18
    /* 1298 80300298 00000000 */  nop
    /* 129C 8030029C 00000000 */  nop
.size boot_decompress, . - boot_decompress
